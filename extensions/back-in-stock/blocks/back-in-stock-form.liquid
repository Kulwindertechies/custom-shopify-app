{% comment %}
  Back in Stock Notification Block
{% endcomment %}

{% liquid
  assign product = block.settings.product | default: product
  assign show_for_all_variants = block.settings.show_for_all_variants
%}

<div class="back-in-stock-wrapper" data-product-id="{{ product.id }}" data-shop="{{ shop.permanent_domain }}">
  <style>
    .back-in-stock-wrapper {
      margin: {{ block.settings.margin_top }}px 0 {{ block.settings.margin_bottom }}px 0;
    }
    .back-in-stock-form { display:none; padding:16px; border:1px solid #e1e3e5; border-radius:8px; background:#f9fafb; margin-top:12px; }
    .back-in-stock-form.show { display:block; }
    .back-in-stock-input { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:12px; }
    .back-in-stock-submit, .back-in-stock-trigger {
      background: {{ block.settings.button_color | default: '#000000' }};
      color: {{ block.settings.button_text_color | default: '#ffffff' }};
      border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%;
    }
    .back-in-stock-submit:hover, .back-in-stock-trigger:hover { opacity:0.9; }
    .back-in-stock-submit:disabled { opacity:0.6; cursor:not-allowed; }
    .back-in-stock-message { margin-top:12px; padding:12px; border-radius:6px; font-size:14px; display:none; }
    .back-in-stock-message.success { background:#d1fae5; color:#065f46; border:1px solid #a7f3d0; }
    .back-in-stock-message.error { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
  </style>

  <div class="back-in-stock-content">
    <button type="button" class="back-in-stock-trigger" id="back-in-stock-trigger-{{ product.id }}">
      {{ block.settings.button_text | default: 'Notify Me When Available' }}
    </button>

    <div class="back-in-stock-form" id="back-in-stock-form-{{ product.id }}">
      <form class="back-in-stock-subscription-form" data-product-id="{{ product.id }}">
        <input
          type="email"
          class="back-in-stock-input"
          placeholder="{{ block.settings.email_placeholder | default: 'Enter your email address' }}"
          required
          name="email"
        >
        <button type="submit" class="back-in-stock-submit">
          {{ block.settings.submit_text | default: 'Notify Me' }}
        </button>
      </form>
    </div>

    <div class="back-in-stock-message" id="back-in-stock-message-{{ product.id }}"></div>
  </div>
</div>

<script>
  (function() {
    const productId = {{ product.id }};
    const shop = '{{ shop.permanent_domain }}';
    const trigger = document.getElementById('back-in-stock-trigger-' + productId);
    const form = document.getElementById('back-in-stock-form-' + productId);
    const messageDiv = document.getElementById('back-in-stock-message-' + productId);
    const subscriptionForm = form.querySelector('.back-in-stock-subscription-form');
    const paymentButton = document.querySelector('.shopify-payment-button'); // target Buy Now button

    /* === Get current variant ID === */
    function getCurrentVariantId() {
      let variantId = {{ product.selected_or_first_available_variant.id | default: 'null' }};
      const urlParams = new URLSearchParams(window.location.search);
      const urlVariantId = urlParams.get('variant');
      if (urlVariantId) return parseInt(urlVariantId);
      if (window.currentVariant && window.currentVariant.id) return window.currentVariant.id;

      const checkedInput = document.querySelector('input[name="id"]:checked');
      if (checkedInput) return parseInt(checkedInput.value);

      const select = document.querySelector('select[name="id"]');
      if (select && select.value) return parseInt(select.value);

      const hiddenInput = document.querySelector('input[type="hidden"][name="id"]');
      if (hiddenInput && hiddenInput.value) return parseInt(hiddenInput.value);

      return variantId;
    }

    /* === Get variant data by ID === */
    function getVariantData(variantId) {
      const variants = {{ product.variants | json }};
      return variants.find(v => v.id === variantId);
    }

    /* === Update payment button visibility === */
    function updatePaymentButton() {
      const variantId = getCurrentVariantId();
      const variant = getVariantData(variantId);
      const isOutOfStock = variant ? !variant.available : false;

      if (paymentButton) {
        paymentButton.style.display = isOutOfStock ? 'none' : 'block';
      }
    }

    /* === Update Back in Stock visibility === */
    function updateBackInStockForm() {
      const wrapper = document.querySelector('.back-in-stock-wrapper[data-product-id="' + productId + '"]');
      const variantId = getCurrentVariantId();
      const variant = getVariantData(variantId);
      const isOutOfStock = variant ? !variant.available : false;

      if (wrapper) {
        wrapper.style.display = isOutOfStock ? 'block' : 'none';
      }

      const variantSpan = document.getElementById('current-variant-id-' + productId);
      if (variantSpan) variantSpan.textContent = variantId;
    }

    /* === Combine updates === */
    function handleVariantChange() {
      updateBackInStockForm();
      updatePaymentButton();
    }

    /* === Event: toggle form === */
    trigger?.addEventListener('click', () => {
      form.classList.toggle('show');
      trigger.style.display = form.classList.contains('show') ? 'none' : 'block';
    });

    /* === Event: form submit === */
    subscriptionForm?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = this.querySelector('input[name="email"]').value;
      const submitBtn = this.querySelector('.back-in-stock-submit');
      if (!email) return showMessage('Please enter a valid email', 'error');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Subscribing...';

      await new Promise(r => setTimeout(r, 100));

      const variantId = getCurrentVariantId();
      try {
        const payload = {
          email: email,
          productId: productId.toString(),
          variantId: variantId ? variantId.toString() : null,
          shop: shop
        };
        const response = await fetch('https://45fbbb4ba584.ngrok-free.app/api/subscription', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.success) {
          showMessage(data.message || 'Subscribed successfully!', 'success');
          form.classList.remove('show');
          trigger.style.display = 'block'; 
          subscriptionForm.reset();
        } else {
          showMessage(data.error || 'Something went wrong', 'error');
        } 
      } catch {
        showMessage('Something went wrong. Try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '{{ block.settings.submit_text | default: "Notify Me" }}';
      }
    });

    /* === Show message helper === */
    function showMessage(msg, type) {
      messageDiv.textContent = msg;
      messageDiv.className = 'back-in-stock-message ' + type;
      messageDiv.style.display = 'block';
      setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
    }

    /* === Variant change listeners === */
    document.addEventListener('variant:change', handleVariantChange);
    document.addEventListener('variantChange', handleVariantChange);
    document.addEventListener('change', e => {
      if (e.target.name === 'id' || e.target.matches('select[name="id"], input[name="id"]')) {
        setTimeout(handleVariantChange, 100);
      }
    });

    /* === Watch for URL change (Shopify themes often change ?variant=) === */
    let lastUrl = window.location.href;
    setInterval(() => {
      if (window.location.href !== lastUrl) {
        lastUrl = window.location.href;
        handleVariantChange();
      }
    }, 500);

    /* === Watch for window.currentVariant change (Dawn theme etc.) === */
    let lastVariantId = null;
    setInterval(() => {
      const cv = window.currentVariant;
      if (cv && cv.id !== lastVariantId) {
        lastVariantId = cv.id;
        handleVariantChange();
      }
    }, 500);

    /* === Initialize === */
    handleVariantChange();
  })();
</script>

{% schema %}
{
  "name": "Back in Stock Form",
  "target": "section",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Leave empty to use the current product page"
    },
    {
      "type": "checkbox",
      "id": "show_for_all_variants",
      "label": "Show when any variant is out of stock",
      "default": false,
      "info": "If unchecked, will only show for the currently selected variant"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Notify Me When Available"
    },
    {
      "type": "text",
      "id": "submit_text",
      "label": "Submit Button Text",
      "default": "Notify Me"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Placeholder",
      "default": "Enter your email address"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "margin_top",
      "label": "Top Margin",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Bottom Margin",
      "min": 0,
      "max": 50,
      "step": 2,
      "default": 16,
      "unit": "px"
    }
  ]
}
{% endschema %}
